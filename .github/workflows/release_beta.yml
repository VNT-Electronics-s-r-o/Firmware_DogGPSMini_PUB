name: Upload BETA firmware

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'FW Version'
        required: true
      environment:
        description: "Environment"
        type: choice
        options:
          - dev
          - prod        

jobs:
  beta:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ github.token }}
      VERSION: ${{ github.event.inputs.version }}
      ENV: ${{ github.event.inputs.environment }}     

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 1) Input pro prostredi a verzi, kontrola souboru
      - name: Detect and check version and env (from filenames without -beta)
        id: detect
        shell: bash
        run: |
          set -e
          if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "::error::Running scritp automatically without specifying version and environment - not allowed and not cool!!!"
            exit 1
          fi
          
          # ovìø, že všechny mají stejnou verzi (bez -beta)
          for f in "${FILES[@]}"; do
              BN="$(basename "$f")"

              # Check version and environment suffix: _dev or _prod
              if [[ "$ENV" == "dev" ]]; then
                  [[ "$BN" == *_dev_v${VERSION}.zip ]] || { echo "::error::Expected _dev_vX file, got: $BN"; exit 1; }
              else
                  [[ "$BN" == *_prod_v${VERSION}.zip ]] || { echo "::error::Expected _prod_vX file, got: $BN"; exit 1; }
              fi
          done

          echo "Detected version: $VERSION"
          echo "::notice::S1"

      # 2) Existují všechny požadované varianty FW (bez -beta v názvu)
      - name: Validate required variants
        id: model
        shell: bash
        run: |
          set -e
          
          test -d release-assets || { echo "::error::Missing release-assets/"; exit 1; }
          ls -la release-assets

          # co pozaduju v danem prostredi za verze
          if [[ "$ENV" == "dev" ]]; then
              REQUIRED="petra_hw2 petra_hw3 petra_hw6"
          else
              REQUIRED="petra_hw2 petra_hw3 petra_hw4"
          fi

          FAIL=0
          for MUT in $REQUIRED; do
            FILE="${MUT}_${ENV}_v${VERSION}.zip"
            if [ ! -f "release-assets/$FILE" ]; then
              echo "::error::Missing expected asset: $FILE"
              FAIL=1
            fi
          done
          [ $FAIL -eq 0 ] || exit 1
          echo "::notice::S2"

      # 3) Pøiprav výstupní složku 'out/' s pøejmenovanými -beta soubory a jejich SHA-256
      - name: Prepare -beta artifacts (copy & rename)
        shell: bash
        run: |
          set -e
          mkdir -p out
          shopt -s nullglob
          for f in release-assets/*.zip; do
            BN="$(basename "$f")"
            # pridani -beta
            NEW="${BN%.zip}-beta.zip"
            cp "release-assets/$BN" "out/$NEW"
          done
          cd out
          for f in *-beta.zip; do
            sha256sum "$f" | awk '{print $1 "  " FILENAME}' FILENAME="$f" > "$f.sha256"
          done
          ls -la
          echo "::notice::S3"

      # 4) Pokud existuje draft pro tuto verzi, smaž shodné -beta assety (aby šel re-run)
      - name: Clean existing -beta assets in existing draft (if any)
        shell: bash
        run: |
          set -e
          
          gh api repos/${GITHUB_REPOSITORY}/releases?per_page=100 > list.json
          RID=$(jq -r \
              --arg ver "v${VERSION}" \
              --arg env_t "v${ENV}" '
                  .[] | select(.draft==true) |
                  select(
                    (.name == ("Firmware " + $ver + " " + $env_t + " BETA")) or
                    (.tag_name == ($ver + "_" + $env_t + "-beta"))
                  ) |
                  .id
              ' list.json | head -n1)
          if [ -n "$RID" ] && [ "$RID" != "null" ]; then
            echo "Found existing draft release id=$RID — cleaning *-beta.* assets"
            gh api repos/${GITHUB_REPOSITORY}/releases/$RID > rel.json
            for f in out/*; do
              BASENAME=$(basename "$f")
              AID=$(jq -r --arg n "$BASENAME" '.assets[] | select(.name==$n) | .id' rel.json)
              if [ -n "$AID" ] && [ "$AID" != "null" ]; then
                echo "Deleting existing asset $BASENAME (id=$AID)"
                gh api -X DELETE repos/${GITHUB_REPOSITORY}/releases/assets/$AID >/dev/null
              fi
            done
          else
            echo "No existing draft found — a new one will be created."
          fi
          echo "::notice::S4"

      # 5) Vytvoø/aktualizuj BETA release jako DRAFT a nahraj *-beta.* artefakty
      - name: Create or Update BETA release (as draft)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}_${{ github.event.inputs.environment }}-beta
          name: Firmware v${{ github.event.inputs.version }} ${{ github.event.inputs.environment }} BETA
          draft: true
          prerelease: false
          files: |
            out/*-beta.zip
            out/*-beta.zip.sha256
